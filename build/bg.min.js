function findParent(a,b){return a?a.className&&a.className.match(b)?a:findParent(a.parentNode,b):!1}function findElementPosition(a){var b=0,c=0;if(a.offsetParent)while(a.offsetParent){b+=a.offsetLeft-a.scrollLeft,c+=a.offsetTop-a.scrollTop;var d="";a.style&&a.style.position&&(d=a.style.position.toLowerCase()),d||a.currentStyle&&a.currentStyle.position&&(d=a.currentStyle.position.toLowerCase());if(d=="absolute"||d=="relative")break;while(a.parentNode!=a.offsetParent)a=a.parentNode,b-=a.scrollLeft,c-=a.scrollTop;a=a.offsetParent}else obj.x&&(b+=obj.x),obj.y&&(c+=obj.y);return{left:b,top:c}}function xhrRequest(a,b,c,d){var e=new XMLHttpRequest;b=="POST"?(e.open(b,a,!0),e.setRequestHeader("Content-type","application/x-www-form-urlencoded"),e.send(c)):(a.match(/\?/)?e.open(b,a+"&"+c,!0):e.open(b,a+"?"+c,!0),e.send()),e.onreadystatechange=function(){e.readyState==4&&(console.log("Response on "+a+" :",e,c),d(e))}}function xhrRedirectUrl(a,b){console.log("ASDASDASD");var c=new XMLHttpRequest;c.open("GET",a,!0),c.send(),console.log("Sending redirect response:",a),c.onreadystatechange=function(){console.log("Redirect response:",c)}}function prettyTime(a){a=parseInt(a);var b=parseInt(a/60),a=a%60;return a<10&&(a="0"+a),b<10&&(b=" "+b),b+":"+a}function timeToSeconds(a){return a=a.split(":"),parseInt(a[0])*60+parseInt(a[1])}function getTrackInfo(a){if(a.getAttribute("data-media-type")=="raw-file")return{file_url:a.getAttribute("data-url"),source_url:document.location.href,source_host:document.location.host,song:a.innerHTML.stripHTML().trim()||"Loading track info...",element_id:a.id,index:0};var b=findParent(a,"ex_container"),c=!1;b.className&&b.className.match("fdl")?c="free":b.className&&b.className.match("streamable")&&(c=!0),window.pageID||(window.pageID=(new Date).getTime());var d={artist:b.getAttribute("data-artist"),song:b.getAttribute("data-song"),album:b.getAttribute("data-album"),track_id:b.getAttribute("data-track-id"),index:parseInt(b.getAttribute("data-index-number")),page_id:window.pageID,source_url:document.location.href,source_host:document.location.host,element_id:a.id,streamable:c};d.song?d.type="track":d.album?d.type="album":d.type="artist";for(var e;e<d.length;e++)d[e]==undefined&&delete d[e];return d}(function(a){String.prototype.trim===a&&(String.prototype.trim=function(){return this.replace(/^\s+/,"").replace(/\s+$/,"")}),Array.prototype.reduce===a&&(Array.prototype.reduce=function(b){if(this===void 0||this===null)throw new TypeError;var c=Object(this),d=c.length>>>0,e=0,f;if(typeof b!="function")throw new TypeError;if(d==0&&arguments.length==1)throw new TypeError;if(arguments.length>=2)f=arguments[1];else do{if(e in c){f=c[e++];break}if(++e>=d)throw new TypeError}while(!0);while(e<d)e in c&&(f=b.call(a,f,c[e],e,c)),e++;return f})})();var Zepto=function(){function a(a){return{}.toString.call(a)=="[object Function]"}function b(a){return a instanceof Object}function c(a){return a instanceof Array}function d(a){return typeof a.length=="number"}function e(a){return a.filter(function(a){return a!==t&&a!==null})}function f(a){return a.length>0?[].concat.apply([],a):a}function g(a){return a.replace(/-+(.)?/g,function(a,b){return b?b.toUpperCase():""})}function h(a){return a.replace(/::/g,"/").replace(/([A-Z]+)([A-Z][a-z])/g,"$1_$2").replace(/([a-z\d])([A-Z])/g,"$1_$2").replace(/_/g,"-").toLowerCase()}function i(a){return a.filter(function(a,b,c){return c.indexOf(a)==b})}function j(a){return a in B?B[a]:B[a]=new RegExp("(^|\\s)"+a+"(\\s|$)")}function k(a,b){return typeof b=="number"&&!D[h(a)]?b+"px":b}function l(a){var b,c;return A[a]||(b=z.createElement(a),z.body.appendChild(b),c=C(b,"").getPropertyValue("display"),b.parentNode.removeChild(b),c=="none"&&(c="block"),A[a]=c),A[a]}function m(a,b){b===t&&E.test(a)&&RegExp.$1,b in J||(b="*");var c=J[b];return c.innerHTML=""+a,y.call(c.childNodes)}function n(a,b){return a=a||x,a.__proto__=n.prototype,a.selector=b||"",a}function o(b,d){if(!b)return n();if(d!==t)return o(d).find(b);if(a(b))return o(z).ready(b);if(b instanceof n)return b;var f;return c(b)?f=e(b):F.indexOf(b.nodeType)>=0||b===window?(f=[b],b=null):E.test(b)?(f=m(b.trim(),RegExp.$1),b=null):b.nodeType&&b.nodeType==3?f=[b]:f=v(z,b),n(f,b)}function p(a,b){return b===t?o(a):o(a).filter(b)}function q(b,c,d,e){return a(c)?c.call(b,d,e):c}function r(a,b,c){var d=a%2?b:b.parentNode;d&&d.insertBefore(c,a?a==1?d.firstChild:a==2?b:null:b.nextSibling)}function s(a,b){b(a);for(var c in a.childNodes)s(a.childNodes[c],b)}var t,u,v,w,x=[],y=x.slice,z=window.document,A={},B={},C=z.defaultView.getComputedStyle,D={"column-count":1,columns:1,"font-weight":1,"line-height":1,opacity:1,"z-index":1,zoom:1},E=/^\s*<(\w+)[^>]*>/,F=[1,9,11],G=["after","prepend","before","append"],H=z.createElement("table"),I=z.createElement("tr"),J={tr:z.createElement("tbody"),tbody:H,thead:H,tfoot:H,td:I,th:I,"*":z.createElement("div")},K=/complete|loaded|interactive/,L=/^\.([\w-]+)$/,M=/^#([\w-]+)$/,N=/^[\w-]+$/;return o.extend=function(a){return y.call(arguments,1).forEach(function(b){for(u in b)a[u]=b[u]}),a},o.qsa=v=function(a,b){var c;return a===z&&M.test(b)?(c=a.getElementById(RegExp.$1))?[c]:x:y.call(L.test(b)?a.getElementsByClassName(RegExp.$1):N.test(b)?a.getElementsByTagName(b):a.querySelectorAll(b))},o.isFunction=a,o.isObject=b,o.isArray=c,o.map=function(a,b){var c,e=[],g,h;if(d(a))for(g=0;g<a.length;g++)c=b(a[g],g),c!=null&&e.push(c);else for(h in a)c=b(a[h],h),c!=null&&e.push(c);return f(e)},o.each=function(a,b){var c,e;if(d(a)){for(c=0;c<a.length;c++)if(b(c,a[c])===!1)return a}else for(e in a)if(b(e,a[e])===!1)return a;return a},o.fn={forEach:x.forEach,reduce:x.reduce,push:x.push,indexOf:x.indexOf,concat:x.concat,map:function(a){return o.map(this,function(b,c){return a.call(b,c,b)})},slice:function(){return o(y.apply(this,arguments))},ready:function(a){return K.test(z.readyState)?a(o):z.addEventListener("DOMContentLoaded",function(){a(o)},!1),this},get:function(a){return a===t?this:this[a]},size:function(){return this.length},remove:function(){return this.each(function(){this.parentNode!=null&&this.parentNode.removeChild(this)})},each:function(a){return this.forEach(function(b,c){a.call(b,c,b)}),this},filter:function(a){return o([].filter.call(this,function(b){return b.parentNode&&v(b.parentNode,a).indexOf(b)>=0}))},end:function(){return this.prevObject||o()},andSelf:function(){return this.add(this.prevObject||o())},add:function(a,b){return o(i(this.concat(o(a,b))))},is:function(a){return this.length>0&&o(this[0]).filter(a).length>0},not:function(b){var c=[];if(a(b)&&b.call!==t)this.each(function(a){b.call(this,a)||c.push(this)});else{var e=typeof b=="string"?this.filter(b):d(b)&&a(b.item)?y.call(b):o(b);this.forEach(function(a){e.indexOf(a)<0&&c.push(a)})}return o(c)},eq:function(a){return a===-1?this.slice(a):this.slice(a,+a+1)},first:function(){var a=this[0];return a&&!b(a)?a:o(a)},last:function(){var a=this[this.length-1];return a&&!b(a)?a:o(a)},find:function(a){var b;return this.length==1?b=v(this[0],a):b=this.map(function(){return v(this,a)}),o(b)},closest:function(a,b){var c=this[0],d=v(b||z,a);d.length||(c=null);while(c&&d.indexOf(c)<0)c=c!==b&&c!==z&&c.parentNode;return o(c)},parents:function(a){var b=[],c=this;while(c.length>0)c=o.map(c,function(a){if((a=a.parentNode)&&a!==z&&b.indexOf(a)<0)return b.push(a),a});return p(b,a)},parent:function(a){return p(i(this.pluck("parentNode")),a)},children:function(a){return p(this.map(function(){return y.call(this.children)}),a)},siblings:function(a){return p(this.map(function(a,b){return y.call(b.parentNode.children).filter(function(a){return a!==b})}),a)},empty:function(){return this.each(function(){this.innerHTML=""})},pluck:function(a){return this.map(function(){return this[a]})},show:function(){return this.each(function(){this.style.display=="none"&&(this.style.display=null),C(this,"").getPropertyValue("display")=="none"&&(this.style.display=l(this.nodeName))})},replaceWith:function(a){return this.each(function(){o(this).before(a).remove()})},wrap:function(a){return this.each(function(){o(this).wrapAll(o(a)[0].cloneNode(!1))})},wrapAll:function(a){return this[0]&&(o(this[0]).before(a=o(a)),a.append(this)),this},unwrap:function(){return this.parent().each(function(){o(this).replaceWith(o(this).children())}),this},hide:function(){return this.css("display","none")},toggle:function(a){return(a===t?this.css("display")=="none":a)?this.show():this.hide()},prev:function(){return o(this.pluck("previousElementSibling"))},next:function(){return o(this.pluck("nextElementSibling"))},html:function(a){return a===t?this.length>0?this[0].innerHTML:null:this.each(function(b){var c=this.innerHTML;o(this).empty().append(q(this,a,b,c))})},text:function(a){return a===t?this.length>0?this[0].textContent:null:this.each(function(){this.textContent=a})},attr:function(a,c){var d;return typeof a=="string"&&c===t?this.length==0?t:a=="value"&&this[0].nodeName=="INPUT"?this.val():!(d=this[0].getAttribute(a))&&a in this[0]?this[0][a]:d:this.each(function(d){if(b(a))for(u in a)this.setAttribute(u,a[u]);else this.setAttribute(a,q(this,c,d,this.getAttribute(a)))})},removeAttr:function(a){return this.each(function(){this.removeAttribute(a)})},data:function(a,b){return this.attr("data-"+a,b)},val:function(a){return a===t?this.length>0?this[0].value:null:this.each(function(b){this.value=q(this,a,b,this.value)})},offset:function(){if(this.length==0)return null;var a=this[0].getBoundingClientRect();return{left:a.left+window.pageXOffset,top:a.top+window.pageYOffset,width:a.width,height:a.height}},css:function(a,b){if(b===t&&typeof a=="string")return this.length==0?t:this[0].style[g(a)]||C(this[0],"").getPropertyValue(a);var c="";for(u in a)c+=h(u)+":"+k(u,a[u])+";";return typeof a=="string"&&(c=h(a)+":"+k(a,b)),this.each(function(){this.style.cssText+=";"+c})},index:function(a){return a?this.indexOf(o(a)[0]):this.parent().children().indexOf(this[0])},hasClass:function(a){return this.length<1?!1:j(a).test(this[0].className)},addClass:function(a){return this.each(function(b){w=[];var c=this.className,d=q(this,a,b,c);d.split(/\s+/g).forEach(function(a){o(this).hasClass(a)||w.push(a)},this),w.length&&(this.className+=(c?" ":"")+w.join(" "))})},removeClass:function(a){return this.each(function(b){if(a===t)return this.className="";w=this.className,q(this,a,b,w).split(/\s+/g).forEach(function(a){w=w.replace(j(a)," ")}),this.className=w.trim()})},toggleClass:function(a,b){return this.each(function(c){var d=q(this,a,c,this.className);(b===t?!o(this).hasClass(d):b)?o(this).addClass(d):o(this).removeClass(d)})}},"filter,add,not,eq,first,last,find,closest,parents,parent,children,siblings".split(",").forEach(function(a){var b=o.fn[a];o.fn[a]=function(){var a=b.apply(this,arguments);return a.prevObject=this,a}}),["width","height"].forEach(function(a){o.fn[a]=function(b){var c,d=a.replace(/./,function(a){return a[0].toUpperCase()});return b===t?this[0]==window?window["inner"+d]:this[0]==z?z.documentElement["offset"+d]:(c=this.offset())&&c[a]:this.each(function(c){var d=o(this);d.css(a,q(this,b,c,d[a]()))})}}),G.forEach(function(a,c){o.fn[a]=function(a){var d=b(a)?a:m(a);if(!("length"in d)||d.nodeType)d=[d];if(d.length<1)return this;var e=this.length,f=e>1,g=c<2;return this.each(function(a,b){for(var h=0;h<d.length;h++){var i=d[g?d.length-h-1:h];s(i,function(a){a.nodeName!=null&&a.nodeName.toUpperCase()==="SCRIPT"&&(!a.type||a.type==="text/javascript")&&window.eval.call(window,a.innerHTML)}),f&&a<e-1&&(i=i.cloneNode(!0)),r(c,b,i)}})};var d=c%2?a+"To":"insert"+(c?"Before":"After");o.fn[d]=function(b){return o(b)[a](this),this}}),n.prototype=o.fn,o}();window.Zepto=Zepto,"$"in window||(window.$=Zepto),function(a){function b(a){return a._zid||(a._zid=m++)}function c(a,c,f,g){c=d(c);if(c.ns)var h=e(c.ns);return(l[b(a)]||[]).filter(function(a){return a&&(!c.e||a.e==c.e)&&(!c.ns||h.test(a.ns))&&(!f||a.fn==f)&&(!g||a.sel==g)})}function d(a){var b=(""+a).split(".");return{e:b[0],ns:b.slice(1).sort().join(" ")}}function e(a){return new RegExp("(?:^| )"+a.replace(" "," .* ?")+"(?: |$)")}function f(b,c,d){a.isObject(b)?a.each(b,d):b.split(/\s/).forEach(function(a){d(a,c)})}function g(c,e,g,h,i){var j=b(c),k=l[j]||(l[j]=[]);f(e,g,function(b,e){var f=i&&i(e,b),g=f||e,j=function(a){var b=g.apply(c,[a].concat(a.data));return b===!1&&a.preventDefault(),b},l=a.extend(d(b),{fn:e,proxy:j,sel:h,del:f,i:k.length});k.push(l),c.addEventListener(l.e,j,!1)})}function h(a,d,e,g){var h=b(a);f(d||"",e,function(b,d){c(a,b,d,g).forEach(function(b){delete l[h][b.i],a.removeEventListener(b.e,b.proxy,!1)})})}function i(b){var c=a.extend({originalEvent:b},b);return a.each(q,function(a,d){c[a]=function(){return this[d]=o,b[a].apply(b,arguments)},c[d]=p}),c}function j(a){if(!("defaultPrevented"in a)){a.defaultPrevented=!1;var b=a.preventDefault;a.preventDefault=function(){this.defaultPrevented=!0,b.call(this)}}}var k=a.qsa,l={},m=1,n={};n.click=n.mousedown=n.mouseup=n.mousemove="MouseEvents",a.event={add:g,remove:h},a.fn.bind=function(a,b){return this.each(function(){g(this,a,b)})},a.fn.unbind=function(a,b){return this.each(function(){h(this,a,b)})},a.fn.one=function(a,b){return this.each(function(c,d){g(this,a,b,null,function(a,b){return function(){var c=a.apply(d,arguments);return h(d,b,a),c}})})};var o=function(){return!0},p=function(){return!1},q={preventDefault:"isDefaultPrevented",stopImmediatePropagation:"isImmediatePropagationStopped",stopPropagation:"isPropagationStopped"};a.fn.delegate=function(b,c,d){return this.each(function(e,f){g(f,c,d,b,function(c){return function(d){var e,g=a(d.target).closest(b,f).get(0);if(g)return e=a.extend(i(d),{currentTarget:g,liveFired:f}),c.apply(g,[e].concat([].slice.call(arguments,1)))}})})},a.fn.undelegate=function(a,b,c){return this.each(function(){h(this,b,c,a)})},a.fn.live=function(b,c){return a(document.body).delegate(this.selector,b,c),this},a.fn.die=function(b,c){return a(document.body).undelegate(this.selector,b,c),this},a.fn.on=function(b,c,d){return c===undefined||a.isFunction(c)?this.bind(b,c):this.delegate(c,b,d)},a.fn.off=function(b,c,d){return c===undefined||a.isFunction(c)?this.unbind(b,c):this.undelegate(c,b,d)},a.fn.trigger=function(b,c){return typeof b=="string"&&(b=a.Event(b)),j(b),b.data=c,this.each(function(){this.dispatchEvent(b)})},a.fn.triggerHandler=function(b,d){var e,f;return this.each(function(g,h){e=i(typeof b=="string"?a.Event(b):b),e.data=d,e.target=h,a.each(c(h,b.type||b),function(a,b){f=b.proxy(e);if(e.isImmediatePropagationStopped())return!1})}),f},"focusin focusout load resize scroll unload click dblclick mousedown mouseup mousemove mouseover mouseout change select keydown keypress keyup error".split(" ").forEach(function(b){a.fn[b]=function(a){return this.bind(b,a)}}),["focus","blur"].forEach(function(b){a.fn[b]=function(a){if(a)this.bind(b,a);else if(this.length)try{this.get(0)[b]()}catch(c){}return this}}),a.Event=function(a,b){var c=document.createEvent(n[a]||"Events"),d=!0;if(b)for(var e in b)e=="bubbles"?d=!!b[e]:c[e]=b[e];return c.initEvent(a,d,!0,null,null,null,null,null,null,null,null,null,null,null,null),c}}(Zepto),function(a){function b(a){var b=this.os={},c=this.browser={},d=a.match(/WebKit\/([\d.]+)/),e=a.match(/(Android)\s+([\d.]+)/),f=a.match(/(iPad).*OS\s([\d_]+)/),g=!f&&a.match(/(iPhone\sOS)\s([\d_]+)/),h=a.match(/(webOS|hpwOS)[\s\/]([\d.]+)/),i=h&&a.match(/TouchPad/),j=a.match(/(BlackBerry).*Version\/([\d.]+)/);d&&(c.version=d[1]),c.webkit=!!d,e&&(b.android=!0,b.version=e[2]),g&&(b.ios=!0,b.version=g[2].replace(/_/g,"."),b.iphone=!0),f&&(b.ios=!0,b.version=f[2].replace(/_/g,"."),b.ipad=!0),h&&(b.webos=!0,b.version=h[2]),i&&(b.touchpad=!0),j&&(b.blackberry=!0,b.version=j[2])}b.call(a,navigator.userAgent),a.__detect=b}(Zepto),function(a,b){function c(a){return a.toLowerCase()}function d(a){return f?f+a:c(a)}var e="",f,g,h,i={Webkit:"webkit",Moz:"",O:"o",ms:"MS"},j=window.document,k=j.createElement("div"),l=/^((translate|rotate|scale)(X|Y|Z|3d)?|matrix(3d)?|perspective|skew(X|Y)?)$/i;a.each(i,function(a,d){if(k.style[a+"TransitionProperty"]!==b)return e="-"+c(a)+"-",f=d,!1}),a.fx={off:f===b&&k.style.transitionProperty===b,cssPrefix:e,transitionEnd:d("TransitionEnd"),animationEnd:d("AnimationEnd")},a.fn.animate=function(b,c,d,e){return a.isObject(c)&&(d=c.easing,e=c.complete,c=c.duration),c&&(c/=1e3),this.anim(b,c,d,e)},a.fn.anim=function(c,d,f,g){var h,i={},j,k=this,m,n=a.fx.transitionEnd;d===b&&(d=.4),a.fx.off&&(d=0);if(typeof c=="string")i[e+"animation-name"]=c,i[e+"animation-duration"]=d+"s",n=a.fx.animationEnd;else{for(j in c)l.test(j)?(h||(h=[]),h.push(j+"("+c[j]+")")):i[j]=c[j];h&&(i[e+"transform"]=h.join(" ")),a.fx.off||(i[e+"transition"]="all "+d+"s "+(f||""))}return m=function(){var b={};b[e+"transition"]=b[e+"animation-name"]="none",a(this).css(b),g&&g.call(this)},d>0&&this.one(n,m),setTimeout(function(){k.css(i),d<=0&&setTimeout(function(){k.each(function(){m.call(this)})},0)},0),this},k=null}(Zepto),function(a){function b(b,c,d){var e=a.Event(c);return a(b).trigger(e,d),!e.defaultPrevented}function c(a,c,d,e){if(a.global)return b(c||n,d,e)}function d(b){b.global&&a.active++===0&&c(b,null,"ajaxStart")}function e(b){b.global&&!--a.active&&c(b,null,"ajaxStop")}function f(a,b){var d=b.context;if(b.beforeSend.call(d,a,b)===!1||c(b,d,"ajaxBeforeSend",[a,b])===!1)return!1;c(b,d,"ajaxSend",[a,b])}function g(a,b,d){var e=d.context,f="success";d.success.call(e,a,f,b),c(d,e,"ajaxSuccess",[b,d,a]),i(f,b,d)}function h(a,b,d,e){var f=e.context;e.error.call(f,d,b,a),c(e,f,"ajaxError",[d,e,a]),i(b,d,e)}function i(a,b,d){var f=d.context;d.complete.call(f,b,a),c(d,f,"ajaxComplete",[b,d]),e(d)}function j(){}function k(b,c,d,e){var f=a.isArray(c);a.each(c,function(c,g){e&&(c=d?e:e+"["+(f?"":c)+"]"),!e&&f?b.add(g.name,g.value):(d?a.isArray(g):m(g))?k(b,g,d,c):b.add(c,g)})}var l=0,m=a.isObject,n=window.document,o,p;a.active=0,a.ajaxJSONP=function(b){var c="jsonp"+ ++l,d=n.createElement("script"),e=function(){a(d).remove(),c in window&&(window[c]=j),i(f,b,"abort")},f={abort:e},h;return window[c]=function(e){clearTimeout(h),a(d).remove(),delete window[c],g(e,f,b)},d.src=b.url.replace(/=\?/,"="+c),a("head").append(d),b.timeout>0&&(h=setTimeout(function(){f.abort(),i(f,b,"timeout")},b.timeout)),f},a.ajaxSettings={type:"GET",beforeSend:j,success:j,error:j,complete:j,context:null,global:!0,xhr:function(){return new window.XMLHttpRequest},accepts:{script:"text/javascript, application/javascript",json:"application/json",xml:"application/xml, text/xml",html:"text/html",text:"text/plain"},crossDomain:!1,timeout:0},a.ajax=function(b){var c=a.extend({},b||{});for(o in a.ajaxSettings)c[o]===undefined&&(c[o]=a.ajaxSettings[o]);d(c),c.crossDomain||(c.crossDomain=/^([\w-]+:)?\/\/([^\/]+)/.test(c.url)&&RegExp.$2!=window.location.host);if(/=\?/.test(c.url))return a.ajaxJSONP(c);c.url||(c.url=window.location.toString()),c.data&&!c.contentType&&(c.contentType="application/x-www-form-urlencoded"),m(c.data)&&(c.data=a.param(c.data));if(c.type.match(/get/i)&&c.data){var e=c.data;c.url.match(/\?.*=/)?e="&"+e:e[0]!="?"&&(e="?"+e),c.url+=e}var i=c.accepts[c.dataType],k={},l=/^([\w-]+:)\/\//.test(c.url)?RegExp.$1:window.location.protocol,n=a.ajaxSettings.xhr(),q;c.crossDomain||(k["X-Requested-With"]="XMLHttpRequest"),i&&(k.Accept=i),c.headers=a.extend(k,c.headers||{}),n.onreadystatechange=function(){if(n.readyState==4){clearTimeout(q);var a,b=!1;if(n.status>=200&&n.status<300||n.status==0&&l=="file:"){if(i=="application/json"&&!/^\s*$/.test(n.responseText))try{a=JSON.parse(n.responseText)}catch(d){b=d}else a=n.responseText;b?h(b,"parsererror",n,c):g(a,n,c)}else h(null,"error",n,c)}},n.open(c.type,c.url,!0),c.contentType&&(c.headers["Content-Type"]=c.contentType);for(p in c.headers)n.setRequestHeader(p,c.headers[p]);return f(n,c)===!1?(n.abort(),!1):(c.timeout>0&&(q=setTimeout(function(){n.onreadystatechange=j,n.abort(),h(null,"timeout",n,c)},c.timeout)),n.send(c.data),n)},a.get=function(b,c){return a.ajax({url:b,success:c})},a.post=function(b,c,d,e){return a.isFunction(c)&&(e=e||d,d=c,c=null),a.ajax({type:"POST",url:b,data:c,success:d,dataType:e})},a.getJSON=function(b,c){return a.ajax({url:b,success:c,dataType:"json"})},a.fn.load=function(b,c){if(!this.length)return this;var d=this,e=b.split(/\s/),f;return e.length>1&&(b=e[0],f=e[1]),a.get(b,function(b){d.html(f?a(n.createElement("div")).html(b).find(f).html():b),c&&c.call(d)}),this};var q=encodeURIComponent;a.param=function(a,b){var c=[];return c.add=function(a,b){this.push(q(a)+"="+q(b))},k(c,a,b),c.join("&").replace("%20","+")}}(Zepto),function(a){a.fn.serializeArray=function(){var b=[],c;return a(Array.prototype.slice.call(this.get(0).elements)).each(function(){c=a(this);var d=c.attr("type");!this.disabled&&d!="submit"&&d!="reset"&&d!="button"&&(d!="radio"&&d!="checkbox"||this.checked)&&b.push({name:c.attr("name"),value:c.val()})}),b},a.fn.serialize=function(){var a=[];return this.serializeArray().forEach(function(b){a.push(encodeURIComponent(b.name)+"="+encodeURIComponent(b.value))}),a.join("&")},a.fn.submit=function(b){if(b)this.bind("submit",b);else if(this.length){var c=a.Event("submit");this.eq(0).trigger(c),c.defaultPrevented||this.get(0).submit()}return this}}(Zepto),function(a){function b(a){return"tagName"in a?a:a.parentNode}function c(a,b,c,d){var e=Math.abs(a-b),f=Math.abs(c-d);return e>=f?a-b>0?"Left":"Right":c-d>0?"Up":"Down"}function d(){e.last&&Date.now()-e.last>=g&&(a(e.target).trigger("longTap"),e={})}var e={},f,g=750;a(document).ready(function(){a(document.body).bind("touchstart",function(a){var c=Date.now(),h=c-(e.last||c);e.target=b(a.touches[0].target),f&&clearTimeout(f),e.x1=a.touches[0].pageX,e.y1=a.touches[0].pageY,h>0&&h<=250&&(e.isDoubleTap=!0),e.last=c,setTimeout(d,g)}).bind("touchmove",function(a){e.x2=a.touches[0].pageX,e.y2=a.touches[0].pageY}).bind("touchend",function(b){e.isDoubleTap?(a(e.target).trigger("doubleTap"),e={}):e.x2>0||e.y2>0?((Math.abs(e.x1-e.x2)>30||Math.abs(e.y1-e.y2)>30)&&a(e.target).trigger("swipe")&&a(e.target).trigger("swipe"+c(e.x1,e.x2,e.y1,e.y2)),e.x1=e.x2=e.y1=e.y2=e.last=0):"last"in e&&(f=setTimeout(function(){f=null,a(e.target).trigger("tap"),e={}},250))}).bind("touchcancel",function(){e={}})}),["swipe","swipeLeft","swipeRight","swipeUp","swipeDown","doubleTap","tap","longTap"].forEach(function(b){a.fn[b]=function(a){return this.bind(b,a)}})}(Zepto);var store=function(){function h(){try{return d in b&&b[d]}catch(a){return!1}}function i(){try{return e in b&&b[e]&&b[e][b.location.hostname]}catch(a){return!1}}var a={},b=window,c=b.document,d="localStorage",e="globalStorage",f="__storejs__",g;a.disabled=!1,a.set=function(a,b){},a.get=function(a){},a.remove=function(a){},a.clear=function(){},a.transact=function(b,c){var d=a.get(b);typeof d=="undefined"&&(d={}),c(d),a.set(b,d)},a.serialize=function(a){return JSON.stringify(a)},a.deserialize=function(a){return typeof a=="undefined"||typeof a!="string"||a==="undefined"||a==="null"?undefined:JSON.parse(a)};if(h())g=b[d],a.set=function(b,c){typeof c=="undefined"||c===null?a.remove(b):g.setItem(b,a.serialize(c))},a.get=function(b){return a.deserialize(g.getItem(b))},a.remove=function(a){g.removeItem(a)},a.clear=function(){g.clear()};else if(i())g=b[e][b.location.hostname],a.set=function(b,c){g[b]=a.serialize(c)},a.get=function(b){return a.deserialize(g[b]&&g[b].value)},a.remove=function(a){delete g[a]},a.clear=function(){for(var a in g)delete g[a]};else if(c.documentElement.addBehavior){var g=c.createElement("div");function j(b){return function(){var e=Array.prototype.slice.call(arguments,0);e.unshift(g),c.body.appendChild(g),g.addBehavior("#default#userData"),g.load(d);var f=b.apply(a,e);return c.body.removeChild(g),f}}a.set=j(function(b,c,e){b.setAttribute(c,a.serialize(e)),b.save(d)}),a.get=j(function(b,c){return a.deserialize(b.getAttribute(c))}),a.remove=j(function(a,b){a.removeAttribute(b),a.save(d)}),a.clear=j(function(a){var b=a.XMLDocument.documentElement.attributes;a.load(d);for(var c=0,e;e=b[c];c++)a.removeAttribute(e.name);a.save(d)})}try{a.set(f,f),a.get(f)!=f&&(a.disabled=!0),a.remove(f)}catch(k){a.disabled=!0}return a}();typeof module!="undefined"&&(module.exports=store),function(){function a(b,c,d){if(b===c)return b!==0||1/b==1/c;if(b==null)return b===c;var e=typeof b;if(e!=typeof c)return!1;if(!b!=!c)return!1;if(v.isNaN(b))return v.isNaN(c);var f=v.isString(b),g=v.isString(c);if(f||g)return f&&g&&String(b)==String(c);f=v.isNumber(b),g=v.isNumber(c);if(f||g)return f&&g&&+b==+c;f=v.isBoolean(b),g=v.isBoolean(c);if(f||g)return f&&g&&+b==+c;f=v.isDate(b),g=v.isDate(c);if(f||g)return f&&g&&b.getTime()==c.getTime();f=v.isRegExp(b),g=v.isRegExp(c);if(f||g)return f&&g&&b.source==c.source&&b.global==c.global&&b.multiline==c.multiline&&b.ignoreCase==c.ignoreCase;if(e!="object")return!1;b._chain&&(b=b._wrapped),c._chain&&(c=c._wrapped);if(v.isFunction(b.isEqual))return b.isEqual(c);for(e=d.length;e--;)if(d[e]==b)return!0;d.push(b),e=0,f=!0;if(b.length===+b.length||c.length===+c.length){if(e=b.length,f=e==c.length)for(;e--;)if(!(f=e in b==e in c&&a(b[e],c[e],d)))break}else{for(var h in b)if(j.call(b,h)&&(e++,!(f=j.call(c,h)&&a(b[h],c[h],d))))break;if(f){for(h in c)if(j.call(c,h)&&!(e--))break;f=!e}}return d.pop(),f}var b=this,c=b._,d={},e=Array.prototype,f=Object.prototype,g=e.slice,h=e.unshift,i=f.toString,j=f.hasOwnProperty,k=e.forEach,l=e.map,m=e.reduce,n=e.reduceRight,o=e.filter,p=e.every,q=e.some,r=e.indexOf,s=e.lastIndexOf,f=Array.isArray,t=Object.keys,u=Function.prototype.bind,v=function(a){return new A(a)};typeof module!="undefined"&&module.exports?(module.exports=v,v._=v):b._=v,v.VERSION="1.2.0";var w=v.each=v.forEach=function(a,b,c){if(a!=null)if(k&&a.forEach===k)a.forEach(b,c);else if(a.length===+a.length){for(var e=0,f=a.length;e<f;e++)if(e in a&&b.call(c,a[e],e,a)===d)break}else for(e in a)if(j.call(a,e)&&b.call(c,a[e],e,a)===d)break};v.map=function(a,b,c){var d=[];return a==null?d:l&&a.map===l?a.map(b,c):(w(a,function(a,e,f){d[d.length]=b.call(c,a,e,f)}),d)},v.reduce=v.foldl=v.inject=function(a,b,c,d){var e=c!==void 0;a==null&&(a=[]);if(m&&a.reduce===m)return d&&(b=v.bind(b,d)),e?a.reduce(b,c):a.reduce(b);w(a,function(a,f,g){e?c=b.call(d,c,a,f,g):(c=a,e=!0)});if(!e)throw new TypeError("Reduce of empty array with no initial value");return c},v.reduceRight=v.foldr=function(a,b,c,d){return a==null&&(a=[]),n&&a.reduceRight===n?(d&&(b=v.bind(b,d)),c!==void 0?a.reduceRight(b,c):a.reduceRight(b)):(a=(v.isArray(a)?a.slice():v.toArray(a)).reverse(),v.reduce(a,b,c,d))},v.find=v.detect=function(a,b,c){var d;return x(a,function(a,e,f){if(b.call(c,a,e,f))return d=a,!0}),d},v.filter=v.select=function(a,b,c){var d=[];return a==null?d:o&&a.filter===o?a.filter(b,c):(w(a,function(a,e,f){b.call(c,a,e,f)&&(d[d.length]=a)}),d)},v.reject=function(a,b,c){var d=[];return a==null?d:(w(a,function(a,e,f){b.call(c,a,e,f)||(d[d.length]=a)}),d)},v.every=v.all=function(a,b,c){var e=!0;return a==null?e:p&&a.every===p?a.every(b,c):(w(a,function(a,f,g){if(!(e=e&&b.call(c,a,f,g)))return d}),e)};var x=v.some=v.any=function(a,b,c){var b=b||v.identity,e=!1;return a==null?e:q&&a.some===q?a.some(b,c):(w(a,function(a,f,g){if(e|=b.call(c,a,f,g))return d}),!!e)};v.include=v.contains=function(a,b){var c=!1;return a==null?c:r&&a.indexOf===r?a.indexOf(b)!=-1:(x(a,function(a){if(c=a===b)return!0}),c)},v.invoke=function(a,b){var c=g.call(arguments,2);return v.map(a,function(a){return(b.call?b||a:a[b]).apply(a,c)})},v.pluck=function(a,b){return v.map(a,function(a){return a[b]})},v.max=function(a,b,c){if(!b&&v.isArray(a))return Math.max.apply(Math,a);if(!b&&v.isEmpty(a))return-Infinity;var d={computed:-Infinity};return w(a,function(a,e,f){e=b?b.call(c,a,e,f):a,e>=d.computed&&(d={value:a,computed:e})}),d.value},v.min=function(a,b,c){if(!b&&v.isArray(a))return Math.min.apply(Math,a);if(!b&&v.isEmpty(a))return Infinity;var d={computed:Infinity};return w(a,function(a,e,f){e=b?b.call(c,a,e,f):a,e<d.computed&&(d={value:a,computed:e})}),d.value},v.shuffle=function(a){var b=[],c;return w(a,function(a,d){d==0?b[0]=a:(c=Math.floor(Math.random()*(d+1)),b[d]=b[c],b[c]=a)}),b},v.sortBy=function(a,b,c){return v.pluck(v.map(a,function(a,d,e){return{value:a,criteria:b.call(c,a,d,e)}}).sort(function(a,b){var c=a.criteria,d=b.criteria;return c<d?-1:c>d?1:0}),"value")},v.groupBy=function(a,b){var c={};return w(a,function(a,d){var e=b(a,d);(c[e]||(c[e]=[])).push(a)}),c},v.sortedIndex=function(a,b,c){c||(c=v.identity);for(var d=0,e=a.length;d<e;){var f=d+e>>1;c(a[f])<c(b)?d=f+1:e=f}return d},v.toArray=function(a){return a?a.toArray?a.toArray():v.isArray(a)?g.call(a):v.isArguments(a)?g.call(a):v.values(a):[]},v.size=function(a){return v.toArray(a).length},v.first=v.head=function(a,b,c){return b!=null&&!c?g.call(a,0,b):a[0]},v.initial=function(a,b,c){return g.call(a,0,a.length-(b==null||c?1:b))},v.last=function(a,b,c){return b!=null&&!c?g.call(a,a.length-b):a[a.length-1]},v.rest=v.tail=function(a,b,c){return g.call(a,b==null||c?1:b)},v.compact=function(a){return v.filter(a,function(a){return!!a})},v.flatten=function(a){return v.reduce(a,function(a,b){return v.isArray(b)?a.concat(v.flatten(b)):(a[a.length]=b,a)},[])},v.without=function(a){return v.difference(a,g.call(arguments,1))},v.uniq=v.unique=function(a,b,c){var c=c?v.map(a,c):a,d=[];return v.reduce(c,function(c,e,f){if(0==f||(b===!0?v.last(c)!=e:!v.include(c,e)))c[c.length]=e,d[d.length]=a[f];return c},[]),d},v.union=function(){return v.uniq(v.flatten(arguments))},v.intersection=v.intersect=function(a){var b=g.call(arguments,1);return v.filter(v.uniq(a),function(a){return v.every(b,function(b){return v.indexOf(b,a)>=0})})},v.difference=function(a,b){return v.filter(a,function(a){return!v.include(b,a)})},v.zip=function(){for(var a=g.call(arguments),b=v.max(v.pluck(a,"length")),c=Array(b),d=0;d<b;d++)c[d]=v.pluck(a,""+d);return c},v.indexOf=function(a,b,c){if(a==null)return-1;var d;if(c)return c=v.sortedIndex(a,b),a[c]===b?c:-1;if(r&&a.indexOf===r)return a.indexOf(b);for(c=0,d=a.length;c<d;c++)if(a[c]===b)return c;return-1},v.lastIndexOf=function(a,b){if(a==null)return-1;if(s&&a.lastIndexOf===s)return a.lastIndexOf(b);for(var c=a.length;c--;)if(a[c]===b)return c;return-1},v.range=function(a,b,c){arguments.length<=1&&(b=a||0,a=0);for(var c=arguments[2]||1,d=Math.max(Math.ceil((b-a)/c),0),e=0,f=Array(d);e<d;)f[e++]=a,a+=c;return f},v.bind=function(a,b){if(a.bind===u&&u)return u.apply(a,g.call(arguments,1));var c=g.call(arguments,2);return function(){return a.apply(b,c.concat(g.call(arguments)))}},v.bindAll=function(a){var b=g.call(arguments,1);return b.length==0&&(b=v.functions(a)),w(b,function(b){a[b]=v.bind(a[b],a)}),a},v.memoize=function(a,b){var c={};return b||(b=v.identity),function(){var d=b.apply(this,arguments);return j.call(c,d)?c[d]:c[d]=a.apply(this,arguments)}},v.delay=function(a,b){var c=g.call(arguments,2);return setTimeout(function(){return a.apply(a,c)},b)},v.defer=function(a){return v.delay.apply(v,[a,1].concat(g.call(arguments,1)))};var y=function(a,b,c){var d;return function(){var e=this,f=arguments,g=function(){d=null,a.apply(e,f)};c&&clearTimeout(d);if(c||!d)d=setTimeout(g,b)}};v.throttle=function(a,b){return y(a,b,!1)},v.debounce=function(a,b){return y(a,b,!0)},v.once=function(a){var b=!1,c;return function(){return b?c:(b=!0,c=a.apply(this,arguments))}},v.wrap=function(a,b){return function(){var c=[a].concat(g.call(arguments));return b.apply(this,c)}},v.compose=function(){var a=g.call(arguments);return function(){for(var b=g.call(arguments),c=a.length-1;c>=0;c--)b=[a[c].apply(this,b)];return b[0]}},v.after=function(a,b){return function(){if(--a<1)return b.apply(this,arguments)}},v.keys=t||function(a){if(a!==Object(a))throw new TypeError("Invalid object");var b=[],c;for(c in a)j.call(a,c)&&(b[b.length]=c);return b},v.values=function(a){return v.map(a,v.identity)},v.functions=v.methods=function(a){var b=[],c;for(c in a)v.isFunction(a[c])&&b.push(c);return b.sort()},v.extend=function(a){return w(g.call(arguments,1),function(b){for(var c in b)b[c]!==void 0&&(a[c]=b[c])}),a},v.defaults=function(a){return w(g.call(arguments,1),function(b){for(var c in b)a[c]==null&&(a[c]=b[c])}),a},v.clone=function(a){return v.isArray(a)?a.slice():v.extend({},a)},v.tap=function(a,b){return b(a),a},v.isEqual=function(b,c){return a(b,c,[])},v.isEmpty=function(a){if(v.isArray(a)||v.isString(a))return a.length===0;for(var b in a)if(j.call(a,b))return!1;return!0},v.isElement=function(a){return!!a&&a.nodeType==1},v.isArray=f||function(a){return i.call(a)==="[object Array]"},v.isObject=function(a){return a===Object(a)},v.isArguments=function(a){return!!a&&!!j.call(a,"callee")},v.isFunction=function(a){return!(!a||!a.constructor||!a.call||!a.apply)},v.isString=function(a){return!!(a===""||a&&a.charCodeAt&&a.substr)},v.isNumber=function(a){return!!(a===0||a&&a.toExponential&&a.toFixed)},v.isNaN=function(a){return a!==a},v.isBoolean=function(a){return a===!0||a===!1||i.call(a)=="[object Boolean]"},v.isDate=function(a){return!(!a||!a.getTimezoneOffset||!a.setUTCFullYear)},v.isRegExp=function(a){return!(!a||!a.test||!a.exec||!a.ignoreCase&&a.ignoreCase!==!1)},v.isNull=function(a){return a===null},v.isUndefined=function(a){return a===void 0},v.noConflict=function(){return b._=c,this},v.identity=function(a){return a},v.times=function(a,b,c){for(var d=0;d<a;d++)b.call(c,d)},v.escape=function(a){return(""+a).replace(/&(?!\w+;|#\d+;|#x[\da-f]+;)/gi,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;").replace(/\//g,"&#x2F;")},v.mixin=function(a){w(v.functions(a),function(b){C(b,v[b]=a[b])})};var z=0;v.uniqueId=function(a){var b=z++;return a?a+b:b},v.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g},v.template=function(a,b){var c=v.templateSettings,c="var __p=[],print=function(){__p.push.apply(__p,arguments);};with(obj||{}){__p.push('"+a.replace(/\\/g,"\\\\").replace(/'/g,"\\'").replace(c.escape,function(a,b){return"',_.escape("+b.replace(/\\'/g,"'")+"),'"}).replace(c.interpolate,function(a,b){return"',"+b.replace(/\\'/g,"'")+",'"}).replace(c.evaluate||null,function(a,b){return"');"+b.replace(/\\'/g,"'").replace(/[\r\n\t]/g," ")+"__p.push('"}).replace(/\r/g,"\\r").replace(/\n/g,"\\n").replace(/\t/g,"\\t")+"');}return __p.join('');",c=new Function("obj",c);return b?c(b):c};var A=function(a){this._wrapped=a};v.prototype=A.prototype;var B=function(a,b){return b?v(a).chain():a},C=function(a,b){A.prototype[a]=function(){var a=g.call(arguments);return h.call(a,this._wrapped),B(b.apply(v,a),this._chain)}};v.mixin(v),w("pop,push,reverse,shift,sort,splice,unshift".split(","),function(a){var b=e[a];A.prototype[a]=function(){return b.apply(this._wrapped,arguments),B(this._wrapped,this._chain)}}),w(["concat","join","slice"],function(a){var b=e[a];A.prototype[a]=function(){return B(b.apply(this._wrapped,arguments),this._chain)}}),A.prototype.chain=function(){return this._chain=!0,this},A.prototype.value=function(){return this._wrapped}}(),function(){var a=this,b=a.Backbone,c;c=typeof exports!="undefined"?exports:a.Backbone={},c.VERSION="0.5.3";var d=a._;!d&&typeof require!="undefined"&&(d=require("underscore")._);var e=a.jQuery||a.Zepto;c.noConflict=function(){return a.Backbone=b,this},c.emulateHTTP=!1,c.emulateJSON=!1,c.Events={bind:function(a,b,c){var d=this._callbacks||(this._callbacks={});return(d[a]||(d[a]=[])).push([b,c]),this},unbind:function(a,b){var c;if(a){if(c=this._callbacks)if(b){c=c[a];if(!c)return this;for(var d=0,e=c.length;d<e;d++)if(c[d]&&b===c[d][0]){c[d]=null;break}}else c[a]=[]}else this._callbacks={};return this},trigger:function(a){var b,c,d,e,f=2;if(!(c=this._callbacks))return this;for(;f--;)if(b=f?a:"all",b=c[b])for(var g=0,h=b.length;g<h;g++)(d=b[g])?(e=f?Array.prototype.slice.call(arguments,1):arguments,d[0].apply(d[1]||this,e)):(b.splice(g,1),g--,h--);return this}},c.Model=function(a,b){var c;a||(a={});if(c=this.defaults)d.isFunction(c)&&(c=c.call(this)),a=d.extend({},c,a);this.attributes={},this._escapedAttributes={},this.cid=d.uniqueId("c"),this.set(a,{silent:!0}),this._changed=!1,this._previousAttributes=d.clone(this.attributes),b&&b.collection&&(this.collection=b.collection),this.initialize(a,b)},d.extend(c.Model.prototype,c.Events,{_previousAttributes:null,_changed:!1,idAttribute:"id",initialize:function(){},toJSON:function(){return d.clone(this.attributes)},get:function(a){return this.attributes[a]},escape:function(a){var b;return(b=this._escapedAttributes[a])?b:(b=this.attributes[a],this._escapedAttributes[a]=(b==null?"":""+b).replace(/&(?!\w+;|#\d+;|#x[\da-f]+;)/gi,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;").replace(/\//g,"&#x2F;"))},has:function(a){return this.attributes[a]!=null},set:function(a,b){b||(b={});if(!a)return this;a.attributes&&(a=a.attributes);var c=this.attributes,e=this._escapedAttributes;if(!b.silent&&this.validate&&!this._performValidation(a,b))return!1;this.idAttribute in a&&(this.id=a[this.idAttribute]);var f=this._changing;this._changing=!0;for(var g in a){var h=a[g];d.isEqual(c[g],h)||(c[g]=h,delete e[g],this._changed=!0,b.silent||this.trigger("change:"+g,this,h,b))}return!f&&!b.silent&&this._changed&&this.change(b),this._changing=!1,this},unset:function(a,b){if(a in this.attributes){b||(b={});var c={};return c[a]=void 0,!b.silent&&this.validate&&!this._performValidation(c,b)?!1:(delete this.attributes[a],delete this._escapedAttributes[a],a==this.idAttribute&&delete this.id,this._changed=!0,b.silent||(this.trigger("change:"+a,this,void 0,b),this.change(b)),this)}return this},clear:function(a){a||(a={});var b,c=this.attributes,d={};for(b in c)d[b]=void 0;if(!a.silent&&this.validate&&!this._performValidation(d,a))return!1;this.attributes={},this._escapedAttributes={},this._changed=!0;if(!a.silent){for(b in c)this.trigger("change:"+b,this,void 0,a);this.change(a)}return this},fetch:function(a){a||(a={});var b=this,d=a.success;return a.success=function(c,e,f){if(!b.set(b.parse(c,f),a))return!1;d&&d(b,c)},a.error=s(a.error,b,a),(this.sync||c.sync).call(this,"read",this,a)},save:function(a,b){b||(b={});if(a&&!this.set(a,b))return!1;var d=this,e=b.success;b.success=function(a,c,f){if(!d.set(d.parse(a,f),b))return!1;e&&e(d,a,f)},b.error=s(b.error,d,b);var f=this.isNew()?"create":"update";return(this.sync||c.sync).call(this,f,this,b)},destroy:function(a){a||(a={});if(this.isNew())return this.trigger("destroy",this,this.collection,a);var b=this,d=a.success;return a.success=function(c){b.trigger("destroy",b,b.collection,a),d&&d(b,c)},a.error=s(a.error,b,a),(this.sync||c.sync).call(this,"delete",this,a)},url:function(){var a=q(this.collection)||this.urlRoot||r();return this.isNew()?a:a+(a.charAt(a.length-1)=="/"?"":"/")+encodeURIComponent(this.id)},parse:function(a){return a},clone:function(){return new this.constructor(this)},isNew:function(){return this.id==null},change:function(a){this.trigger("change",this,a),this._previousAttributes=d.clone(this.attributes),this._changed=!1},hasChanged:function(a){return a?this._previousAttributes[a]!=this.attributes[a]:this._changed},changedAttributes:function(a){a||(a=this.attributes);var b=this._previousAttributes,c=!1,e;for(e in a)d.isEqual(b[e],a[e])||(c=c||{},c[e]=a[e]);return c},previous:function(a){return!a||!this._previousAttributes?null:this._previousAttributes[a]},previousAttributes:function(){return d.clone(this._previousAttributes)},_performValidation:function(a,b){var c=this.validate(a);return c?(b.error?b.error(this,c,b):this.trigger("error",this,c,b),!1):!0}}),c.Collection=function(a,b){b||(b={}),b.comparator&&(this.comparator=b.comparator),d.bindAll(this,"_onModelEvent","_removeReference"),this._reset(),a&&this.reset(a,{silent:!0}),this.initialize.apply(this,arguments)},d.extend(c.Collection.prototype,c.Events,{model:c.Model,initialize:function(){},toJSON:function(){return this.map(function(a){return a.toJSON()})},add:function(a,b){if(d.isArray(a))for(var c=0,e=a.length;c<e;c++)this._add(a[c],b);else this._add(a,b);return this},remove:function(a,b){if(d.isArray(a))for(var c=0,e=a.length;c<e;c++)this._remove(a[c],b);else this._remove(a,b);return this},get:function(a){return a==null?null:this._byId[a.id!=null?a.id:a]},getByCid:function(a){return a&&this._byCid[a.cid||a]},at:function(a){return this.models[a]},sort:function(a){a||(a={});if(!this.comparator)throw Error("Cannot sort a set without a comparator");return this.models=this.sortBy(this.comparator),a.silent||this.trigger("reset",this,a),this},pluck:function(a){return d.map(this.models,function(b){return b.get(a)})},reset:function(a,b){return a||(a=[]),b||(b={}),this.each(this._removeReference),this._reset(),this.add(a,{silent:!0}),b.silent||this.trigger("reset",this,b),this},fetch:function(a){a||(a={});var b=this,d=a.success;return a.success=function(c,e,f){b[a.add?"add":"reset"](b.parse(c,f),a),d&&d(b,c)},a.error=s(a.error,b,a),(this.sync||c.sync).call(this,"read",this,a)},create:function(a,b){var c=this;b||(b={}),a=this._prepareModel(a,b);if(!a)return!1;var d=b.success;return b.success=function(a,e,f){c.add(a,b),d&&d(a,e,f)},a.save(null,b),a},parse:function(a){return a},chain:function(){return d(this.models).chain()},_reset:function(){this.length=0,this.models=[],this._byId={},this._byCid={}},_prepareModel:function(a,b){if(a instanceof c.Model)a.collection||(a.collection=this);else{var d=a;a=new this.model(d,{collection:this}),a.validate&&!a._performValidation(d,b)&&(a=!1)}return a},_add:function(a,b){b||(b={}),a=this._prepareModel(a,b);if(!a)return!1;var c=this.getByCid(a);if(c)throw Error(["Can't add the same model to a set twice",c.id]);return this._byId[a.id]=a,this._byCid[a.cid]=a,this.models.splice(b.at!=null?b.at:this.comparator?this.sortedIndex(a,this.comparator):this.length,0,a),a.bind("all",this._onModelEvent),this.length++,b.silent||a.trigger("add",a,this,b),a},_remove:function(a,b){return b||(b={}),a=this.getByCid(a)||this.get(a),a?(delete this._byId[a.id],delete this._byCid[a.cid],this.models.splice(this.indexOf(a),1),this.length--,b.silent||a.trigger("remove",a,this,b),this._removeReference(a),a):null},_removeReference:function(a){this==a.collection&&delete a.collection,a.unbind("all",this._onModelEvent)},_onModelEvent:function(a,b,c,d){(a=="add"||a=="remove")&&c!=this||(a=="destroy"&&this._remove(b,d),b&&a==="change:"+b.idAttribute&&(delete this._byId[b.previous(b.idAttribute)],this._byId[b.id]=b),this.trigger.apply(this,arguments))}}),d.each(["forEach","each","map","reduce","reduceRight","find","detect","filter","select","reject","every","all","some","any","include","contains","invoke","max","min","sortBy","sortedIndex","toArray","size","first","rest","last","without","indexOf","lastIndexOf","isEmpty","groupBy"],function(a){c.Collection.prototype[a]=function(){return d[a].apply(d,[this.models].concat(d.toArray(arguments)))}}),c.Router=function(a){a||(a={}),a.routes&&(this.routes=a.routes),this._bindRoutes(),this.initialize.apply(this,arguments)};var f=/:([\w\d]+)/g,g=/\*([\w\d]+)/g,h=/[-[\]{}()+?.,\\^$|#\s]/g;d.extend(c.Router.prototype,c.Events,{initialize:function(){},route:function(a,b,e){c.history||(c.history=new c.History),d.isRegExp(a)||(a=this._routeToRegExp(a)),c.history.route(a,d.bind(function(c){c=this._extractParameters(a,c),e.apply(this,c),this.trigger.apply(this,["route:"+b].concat(c))},this))},navigate:function(a,b){c.history.navigate(a,b)},_bindRoutes:function(){if(this.routes){var a=[],b;for(b in this.routes)a.unshift([b,this.routes[b]]);b=0;for(var c=a.length;b<c;b++)this.route(a[b][0],a[b][1],this[a[b][1]])}},_routeToRegExp:function(a){return a=a.replace(h,"\\$&").replace(f,"([^/]*)").replace(g,"(.*?)"),RegExp("^"+a+"$")},_extractParameters:function(a,b){return a.exec(b).slice(1)}}),c.History=function(){this.handlers=[],d.bindAll(this,"checkUrl")};var i=/^#*/,j=/msie [\w.]+/,k=!1;d.extend(c.History.prototype,{interval:50,getFragment:function(a,b){if(a==null)if(this._hasPushState||b){a=window.location.pathname;var c=window.location.search;c&&(a+=c),a.indexOf(this.options.root)==0&&(a=a.substr(this.options.root.length))}else a=window.location.hash;return decodeURIComponent(a.replace(i,""))},start:function(a){if(k)throw Error("Backbone.history has already been started");this.options=d.extend({},{root:"/"},this.options,a),this._wantsPushState=!!this.options.pushState,this._hasPushState=!(!this.options.pushState||!window.history||!window.history.pushState),a=this.getFragment();var b=document.documentMode;if(b=j.exec(navigator.userAgent.toLowerCase())&&(!b||b<=7))this.iframe=e('<iframe src="javascript:0" tabindex="-1" />').hide().appendTo("body")[0].contentWindow,this.navigate(a);this._hasPushState?e(window).bind("popstate",this.checkUrl):"onhashchange"in window&&!b?e(window).bind("hashchange",this.checkUrl):setInterval(this.checkUrl,this.interval),this.fragment=a,k=!0,a=window.location,b=a.pathname==this.options.root;if(this._wantsPushState&&!this._hasPushState&&!b)return this.fragment=this.getFragment(null,!0),window.location.replace(this.options.root+"#"+this.fragment),!0;this._wantsPushState&&this._hasPushState&&b&&a.hash&&(this.fragment=a.hash.replace(i,""),window.history.replaceState({},document.title,a.protocol+"//"+a.host+this.options.root+this.fragment));if(!this.options.silent)return this.loadUrl()},route:function(a,b){this.handlers.unshift({route:a,callback:b})},checkUrl:function(){var a=this.getFragment();a==this.fragment&&this.iframe&&(a=this.getFragment(this.iframe.location.hash));if(a==this.fragment||a==decodeURIComponent(this.fragment))return!1;this.iframe&&this.navigate(a),this.loadUrl()||this.loadUrl(window.location.hash)},loadUrl:function(a){var b=this.fragment=this.getFragment(a);return d.any(this.handlers,function(a){if(a.route.test(b))return a.callback(b),!0})},navigate:function(a,b){var c=(a||"").replace(i,"");if(this.fragment!=c&&this.fragment!=decodeURIComponent(c)){if(this._hasPushState){var d=window.location;c.indexOf(this.options.root)!=0&&(c=this.options.root+c),this.fragment=c,window.history.pushState({},document.title,d.protocol+"//"+d.host+c)}else if(window.location.hash=this.fragment=c,this.iframe&&c!=this.getFragment(this.iframe.location.hash))this.iframe.document.open().close(),this.iframe.location.hash=c;b&&this.loadUrl(a)}}}),c.View=function(a){this.cid=d.uniqueId("view"),this._configure(a||{}),this._ensureElement(),this.delegateEvents(),this.initialize.apply(this,arguments)};var l=/^(\S+)\s*(.*)$/,m=["model","collection","el","id","attributes","className","tagName"];d.extend(c.View.prototype,c.Events,{tagName:"div",$:function(a){return e(a,this.el)},initialize:function(){},render:function(){return this},remove:function(){return e(this.el).remove(),this},make:function(a,b,c){return a=document.createElement(a),b&&e(a).attr(b),c&&e(a).html(c),a},delegateEvents:function(a){if(a||(a=this.events))for(var b in d.isFunction(a)&&(a=a.call(this)),e(this.el).unbind(".delegateEvents"+this.cid),a){var c=this[a[b]];if(!c)throw Error('Event "'+a[b]+'" does not exist');var f=b.match(l),g=f[1];f=f[2],c=d.bind(c,this),g+=".delegateEvents"+this.cid,f===""?e(this.el).bind(g,c):e(this.el).delegate(f,g,c)}},_configure:function(a){this.options&&(a=d.extend({},this.options,a));for(var b=0,c=m.length;b<c;b++){var e=m[b];a[e]&&(this[e]=a[e])}this.options=a},_ensureElement:function(){if(this.el)d.isString(this.el)&&(this.el=e(this.el).get(0));else{var a=this.attributes||{};this.id&&(a.id=this.id),this.className&&(a["class"]=this.className),this.el=this.make(this.tagName,a)}}}),c.Model.extend=c.Collection.extend=c.Router.extend=c.View.extend=function(a,b){var c=p(this,a,b);return c.extend=this.extend,c};var n={create:"POST",update:"PUT","delete":"DELETE",read:"GET"};c.sync=function(a,b,f){var g=n[a];return f=d.extend({type:g,dataType:"json"},f),f.url||(f.url=q(b)||r()),!f.data&&b&&(a=="create"||a=="update")&&(f.contentType="application/json",f.data=JSON.stringify(b.toJSON())),c.emulateJSON&&(f.contentType="application/x-www-form-urlencoded",f.data=f.data?{model:f.data}:{}),c.emulateHTTP&&(g==="PUT"||g==="DELETE")&&(c.emulateJSON&&(f.data._method=g),f.type="POST",f.beforeSend=function(a){a.setRequestHeader("X-HTTP-Method-Override",g)}),f.type!=="GET"&&!c.emulateJSON&&(f.processData=!1),e.ajax(f)};var o=function(){},p=function(a,b,c){var e;return e=b&&b.hasOwnProperty("constructor")?b.constructor:function(){return a.apply(this,arguments)},d.extend(e,a),o.prototype=a.prototype,e.prototype=new o,b&&d.extend(e.prototype,b),c&&d.extend(e,c),e.prototype.constructor=e,e.__super__=a.prototype,e},q=function(a){return!a||!a.url?null:d.isFunction(a.url)?a.url():a.url},r=function(){throw Error('A "url" property or function must be specified')},s=function(a,b,c){return function(d){a?a(b,d,c):b.trigger("error",b,d,c)}}}.call(this),function(){var a,b;b=this,a=function(){function a(){_.bindAll(this),this.loadPlugins()}return a.prototype.baseURL="http://chromusapp-v2.appspot.com",a.prototype.audio_players={},a.prototype.audio_sources={},a.prototype.media_types={},a.prototype.plugins={},a.prototype.plugins_info={},a.prototype.plugins_list=["iframe_player","music_manager","ui","echonest","lastfm","loved_tracks_radio","vkontakte","about"],a.prototype.injectPluginFiles=function(){var a,b,c,d,e,f;a=[],f=this.plugins_list;for(d=0,e=f.length;d<e;d++)c=f[d],b=this.plugins_info[c],a.push(_.map(b.files,function(a){var c;return c=a.match(/(.*!)?(.*)/),""+(c[1]||"")+b.path+"/"+c[2]+"?"+ +(new Date)}));return yepnope({load:_.flatten(a),complete:this.pluginsLoadedCallback})},a.prototype.loadPlugins=function(){var a,c,d,e,f,g,h=this;a=_.after(this.plugins_list.length,this.injectPluginFiles),f=this.plugins_list,g=[];for(d=0,e=f.length;d<e;d++)c=f[d],g.push(function(c){var d,e;return e=browser.extension.getURL("/plugins/"+c),d=""+e+"/package.json?"+ +(new Date),b.debug||typeof exports!="undefined"&&exports!==null?$.getJSON(d,function(b){return h.plugins_info[c]=b,h.plugins_info[c].path=e,a()}):(h.plugins_info[c]={},h.plugins_info[c].path=e)}(c));return g},a.prototype.pluginsLoadedCallback=function(){if(typeof b.isTestMode=="function"?b.isTestMode():void 0)return jasmine.getEnv().addReporter(new jasmine.TrivialReporter),jasmine.getEnv().execute()},a.prototype.registerPlugin=function(a,b){return this.plugins[a]=b},a.prototype.registerPlayer=function(a,b){return this.audio_players[a]=b},a.prototype.registerAudioSource=function(a,b){return this.audio_sources[a]=b},a.prototype.registerMediaType=function(a,b){return this.media_types[a]=b},a.prototype.addMenu=function(a){return $("#main_menu").append(a)},a.prototype.openPanel=function(a){var b;return b=$('<div class="panel">').html(a).appendTo($("#wrapper")).delegate(".back","click",function(){return b.removeClass("show"),_.delay(function(){return b.remove()},300)}),_.defer(function(){return b.addClass("show")}),b},a.prototype.closePanel=function(){var a;return a=_.last($(".panel")),$(a).find(".back").trigger("click")},a}(),this.chromus=new a,this.chromus.utils={uid:function(){var a;return(a=this.uid_start)==null&&(this.uid_start=+(new Date)),this.uid_start++}}}.call(this),String.prototype.replaceEntities=function(){return this.replace(/&amp;/g,"&").replace(/%27/g,"'")},String.prototype.stripHTML=function(){var a=document.createElement("DIV");return a.innerHTML=this,a.textContent||a.innerText},Function.prototype.bind=function(a){var b=this;return function(){return b.apply(a,arguments)}},Array.prototype.diff=function(a){return this.filter(function(b){return!(a.indexOf(b)>-1)})},Array.prototype.random=function(){return this[Math.floor(Math.random()*this.length)]},window.getTrackInfo=getTrackInfo,window.findParent=findParent,function(){var a,b=Object.prototype.hasOwnProperty,c=function(a,c){function e(){this.constructor=a}for(var d in c)b.call(c,d)&&(a[d]=c[d]);return e.prototype=c.prototype,a.prototype=new e,a.__super__=c.prototype,a};a=function(){function a(){a.__super__.constructor.apply(this,arguments)}return c(a,Backbone.Model),a.prototype.player_url="http://chromusapp.appspot.com/",a.prototype.initialize=function(){return _.bindAll(this),this.path=chromus.plugins_info.iframe_player.path,this.state=new Backbone.Model,this.createFrame()},a.prototype.createFrame=function(){return this.player_frame=document.createElement("iframe"),this.player_frame.id="player_frame",this.player_frame.style.display="none",!browser.isFrame&&!browser.isSafari?this.player_frame.src=this.player_url+"sm2_iframe":this.player_frame.src=""+this.path+"/lib/iframe.htm?"+ +(new Date),document.body.appendChild(this.player_frame),this.player_ready=!1,window.addEventListener("message",this.listener,!1)},a.prototype.listener=function(a){var b;if(!a.data)return;b=JSON.parse(a.data);switch(b.method){case"sm2:playerState":return this.state.set(b.state);case"sm2:ready":return this.player_ready=!0;case"sm2:finished":return this.state.set({name:"stopped"}),this.state.unset("name",{silent:!0})}},a.prototype.postMessageToPlayer=function(a){return this.player_frame.contentWindow.postMessage(JSON.stringify(a),"*")},a.prototype.play=function(a){return this.state.unset("name",{silent:!0}),this.postMessageToPlayer({method:"play",url:a.file_url,track:a.id,use_flash:a.use_flash}),this.setVolume()},a.prototype.preload=function(a){return this.postMessageToPlayer({method:"preload",url:a.file_url,track:a.id,use_flash:a.use_flash})},a.prototype.pause=function(){return this.postMessageToPlayer({method:"pause"})},a.prototype.stop=function(){return this.postMessageToPlayer({method:"stop"})},a.prototype.setVolume=function(a){return a==null&&(a=this.value),this.value=a!=null?a:100,this.postMessageToPlayer({method:"setVolume",volume:this.value})},a.prototype.setPosition=function(a){return this.postMessageToPlayer({method:"setPosition",position:a})},a}(),this.chromus.registerPlayer("iframe_player",new a)}.call(this),function(){var a,b,c,d,e=Object.prototype.hasOwnProperty,f=function(a,b){function d(){this.constructor=a}for(var c in b)e.call(b,c)&&(a[c]=b[c]);return d.prototype=b.prototype,a.prototype=new d,a.__super__=b.prototype,a};c=function(){function a(){a.__super__.constructor.apply(this,arguments)}return f(a,Backbone.Model),a.prototype.initialize=function(){return this.set({id:this.id?void 0:chromus.utils.uid()})},a.prototype.title=function(){return""+this.get("song")+"  "+this.get("artist")},a}(),b=function(){function a(){a.__super__.constructor.apply(this,arguments)}return f(a,Backbone.Collection),a.prototype.model=c,a}(),a=function(){function a(){a.__super__.constructor.apply(this,arguments)}return f(a,Backbone.Model),a.prototype.initialize=function(){return _.bindAll(this,"onPlaylistReset","updateState"),this.playlist=new b,this.state=new Backbone.Model,this.settings=new Backbone.Model,this.playlist.bind("reset",this.onPlaylistReset),this.playlist.reset(),this.setPlayer(),this.setVolume()},a.prototype.setPlayer=function(a){return a==null&&(a="iframe_player"),this.player&&this.player.state.unbind(),this.player=chromus.audio_players[a],this.player.state.bind("change",this.updateState)},a.prototype.onPlaylistReset=function(){return this.stop()},a.prototype.currentTrack=function(){return this.playlist.get(this.get("current_track"))},a.prototype.nextTrack=function(){var a,b;if(!this.get("current_track"))return;return this.settings.get("shuffle")?this.playlist.models[Math.floor(Math.random()*this.playlist.length-1)]:(a=this.playlist.indexOf(this.currentTrack()),b=this.playlist.models[a+1],this.settings.get("repeat")&&!b?this.playlist.first():b)},a.prototype.prevTrack=function(){var a;return a=this.playlist.indexOf(this.currentTrack()),this.playlist.models[a-1]},a.prototype.setEmptyState=function(){return this.state.set({duration:0,played:0,buffered:0,name:"stopped"})},a.prototype.updateState=function(a){this.state.set(a.toJSON());if(a.get("name")==="stopped")return this.play(this.nextTrack())},a.prototype.searchTrack=function(a,b){var c,d,e,f,g,h,i=this;b==null&&(b=function(){}),e=[],f=function(){var c;return _.isEmpty(e)?b():(c=e[0],a.set({file_url:c.file_url,duration:c.duration}),a.get("source_title")||a.set({source_title:c.source_title,source_icon:c.source_icon}),b(a))},g=chromus.audio_sources,h=[];for(c in g)d=g[c],h.push(d.search({artist:a.get("artist"),song:a.get("song")},function(a){return e=_.union(e,a),f()}));return h},a.prototype.play=function(a){var b=this;if(!a)return;return _.isObject(a)||(a=this.playlist.get(a)),_.isFunction(a.get)||(a=new c(a)),a.get("action")||(a!==this.currentTrack()&&this.stop(),a.get("type")==null&&this.set({current_track:a.id}),this.state.set({name:"loading"})),console.warn("trying to play track",a),a.get("type")?this._handleMediaType(a):a.get("file_url")?(this.state.set({name:"playing"}),this.player.play(a.toJSON())):this.searchTrack(a,function(a){return a?b.play(a):b.play(b.nextTrack())})},a.prototype._handleMediaType=function(a,b){var c,d=this;b==null&&(b=a.get("type")),console.warn("trying to handle media type",a);if(!(c=chromus.media_types[b]))throw"Can't find handler for media type `"+b+"`";return c(a,function(b){return console.warn("resp",b),_.isArray(b)?(d.playlist.reset(b),d.play(d.playlist.first())):(a.set(b),a.unset("type"),d.play(a))})},a.prototype.pause=function(){return this.state.set({name:"paused"}),this.player.pause()},a.prototype.preload=function(a){return this.player.preload(a.toJSON())},a.prototype.stop=function(){return this.unset("current_track"),this.state.set({name:"stopped"},{silent:!0}),this.player&&this.player.stop(),this.setEmptyState()},a.prototype.setPosition=function(a){return this.player.setPosition(a)},a.prototype.setVolume=function(a){return a!=null&&(this.volume=a),this.player.setVolume(this.volume)},a.prototype.getVolume=function(){var a;return(a=this.volume)!=null?a:100},a}(),d=new a,chromus.registerPlugin("music_manager",d),browser.isPokki&&d.state.bind("change",function(a){return a.get("name")==="playing"?pokki.setIdleDetect("background",!1):pokki.setIdleDetect("background",!0)})}.call(this),function(){var a;a=chromus.plugins.music_manager,browser.addMessageListener(function(b,c,d){var e,f,g,h,i,j=this;b.method.match("(playerState|updateState)")||console.log(b.method,b,c);switch(b.method){case"pause":return a.pause();case"play":return _.isArray(b.track)?(a.playlist.reset(b.track),a.play(a.playlist.first())):a.play(b.track);case"addToPlaylist":h=b.tracks,i=[];for(f=0,g=h.length;f<g;f++)e=h[f],e.type?(e=new Backbone.Model(e),i.push(chromus.media_types[e.get("type")](e,function(b){return a.playlist.remove(e),a.playlist.add(b)}))):i.push(a.playlist.add(e));return i;case"nextTrack":return a.play(a.nextTrack());case"previousTrack":return a.play(a.prevTrack());case"setVolume":return a.setVolume(b.volume);case"setPosition":return a.setPosition(b.position);case"setSettings":return a.settings.set(b.data);case"clearPlaylist":return a.playlist.reset()}})}.call(this),function(){var a,b,c,d,e;b=chromus.plugins.music_manager,b.state.bind("change",function(a){var c,d,e;return e=b.currentTrack(),c=a.get("duration")-a.get("played"),a.get("name")==="stopped"||c<=0?browser.toolbarItem.setText(""):browser.toolbarItem.setText(prettyTime(c)),e&&(d="(-"+prettyTime(c).trim()+")  "+e.title(),browser.toolbarItem.setTitle(d)),browser.broadcastMessage({method:"updateState",state:a,track:e})}),e=["reset","add","create","change:song"];for(c=0,d=e.length;c<d;c++)a=e[c],b.playlist.bind(a,function(){return browser.postMessage({method:"loadPlaylist",playlist:b.playlist.toJSON(),current_track:b.get("current_track"),state:b.state.toJSON()})});b.settings.bind("change",function(a){return browser.postMessage({method:"updateSettings",settings:a.toJSON()})}),browser.addMessageListener(function(a,c,d){switch(a.method){case"ui:init":return browser.postMessage({method:"loadPlaylist",playlist:b.playlist.toJSON(),current_track:b.get("current_track"),state:b.state.toJSON(),volume:b.getVolume(),settings:b.settings.toJSON()})}})}.call(this),function(){var a,b;a={settings:{baseURL:"http://developer.echonest.com/api/v4",format:"jsonp",api_key:"D3QELXPGA1KC6AJ6U"},callMethod:function(a,b,c){return b==null&&(b={}),b.format=this.settings.format,b.api_key=this.settings.api_key,$.ajax({url:""+this.settings.baseURL+"/"+a,data:b,cache:!0,dataType:this.settings.format,success:function(a){return console.log("Echo response:",a),c(a.response)}})},song:{search:function(b,c){return a.callMethod("song/search",{combined:b,sort:"artist_familiarity-desc"},function(a){return c(a.songs)})}},artist:{suggest:function(b,c){return a.callMethod("artist/suggest",{name:b},function(a){return c(a.artists)})}}},(b=this.chromus)!=null&&b.registerPlugin("echo",a)}.call(this),function(){var a,b,c=Object.prototype.hasOwnProperty;b=function(a){var b,d,e;d=[];for(b in a){if(!c.call(a,b))continue;e=a[b],d.push(""+b+"="+e)}return d.join("&")},a={settings:{baseURL:"http://ws.audioscrobbler.com/2.0/",format:"json",api_key:"48e602d0f8c4d34f00b1b17d96ab88c1",api_secret:"c129f28ec70abc4311b21fa8473d34e7"},getSignature:function(b){var d,e,f;e=[];for(d in b){if(!c.call(b,d))continue;f=b[d],d!=="format"&&e.push(d+f)}return e.sort(),MD5(e.join("")+a.settings.api_secret)},getSession:function(){return browser.isPokki?pokki.descramble(store.get("lastfm:key")):store.get("lastfm:key")},callMethod:function(b,c,d){return c==null&&(c={}),c.format=this.settings.format,c.api_key=this.settings.api_key,c.method=b,c.sig_call&&(delete c.sig_call,b.match(/^auth/)||(c.sk=a.getSession()),c.api_sig=this.getSignature(c)),$.ajax({url:""+this.settings.baseURL,data:c,cache:!0,dataType:this.settings.format,success:function(a){return console.log("Lastfm response:",a),d(a)},error:function(a){return d({error:"asd"})}})},convertDateToUTC:function(a){return a==null&&(a=new Date),new Date(a.getUTCFullYear(),a.getUTCMonth(),a.getUTCDate(),a.getUTCHours(),a.getUTCMinutes(),a.getUTCSeconds())},fakePostRequest:function(a,b){var d,e,f,g,h;e=document.createElement("iframe"),e.name=e.id=+(new Date),document.body.appendChild(e),d=document.createElement("form"),d.action=a,d.method="post",d.target=e.id;for(g in b){if(!c.call(b,g))continue;h=b[g],f=document.createElement("input"),f.name=g,f.value=h,d.appendChild(f)}return document.body.appendChild(d),d.submit(),setTimeout(function(){return document.body.removeChild(e),document.body.removeChild(d)},2e3)},track:{scrobble:function(b,c){var d;return b.method="track.scrobble",b.timestamp=+(new Date)/1e3|0,b.sk=a.getSession(),b.api_key=a.settings.api_key,d=a.getSignature(b),b.api_sig=d,a.fakePostRequest(""+a.settings.baseURL,b)},updateNowPlaying:function(b,c){var d;return b.method="track.updateNowPlaying",b.sk=a.getSession(),b.api_key=a.settings.api_key,d=a.getSignature(b),b.api_sig=d,a.fakePostRequest(""+a.settings.baseURL,b)},search:function(b,c){return a.callMethod("track.search",{track:b},function(a){var b;return c((b=a.results.trackmatches)!=null?b.track:void 0)})}},artist:{search:function(b,c){return a.callMethod("artist.search",{artist:b},function(a){var b;return c((b=a.results.artistmatches)!=null?b.artist:void 0)})},getTopTracks:function(b,c){return a.callMethod("artist.getTopTracks",{artist:b},function(a){var b;return b=a.toptracks.track,b=_.map(b,function(a){return{artist:a.artist.name,song:a.name,duration:parseInt(a.duration),images:a.image}}),c(b)})}},album:{search:function(b,c){return a.callMethod("album.search",{album:b},function(a){var b;return c((b=a.results.albummatches)!=null?b.album:void 0)})},getInfo:function(b,c,d){return a.callMethod("album.getInfo",{album:c,artist:b},function(a){var b;return b=a.album.tracks.track,b=_.map(b,function(a){return{artist:a.artist.name,song:a.name,duration:parseInt(a.duration),images:a.images}}),d(b)})}},image:function(b){var c,d,e;if(!b.artist)return;return(e=b.size)==null&&(b.size="mediumsquare"),d=[],b.album?(c="album",d.push("album="+encodeURIComponent(b.album))):(c="artist",d.push("artist="+encodeURIComponent(b.artist))),""+a.settings.baseURL+"?api_key="+a.settings.api_key+"&method="+c+".getImageRedirect&size="+b.size+"&"+d.join("&")},radio:{getPlaylist:function(b){return a.callMethod("radio.getPlaylist",{sig_call:!0},function(a){var c;return c=a.playlist.trackList.track,c=_.map(c,function(b){return{artist:b.creator,song:b.title,file_url:b.location,images:[b.image],duration:b.duration/1e3,lastfm_radio:!0,type:"lastfm:stream_track",source_title:a.playlist.title,source_icon:"http://cdn.last.fm/flatness/favicon.2.ico"}}),c.push({song:"Load next tracks",artist:"",type:"lastfm:radio_loader",action:!0}),b(c)})},tune:function(b,c){var d,e;return b.match(/loved$/)?(a._station="loved",c()):(d={station:b},d.method="radio.tune",d.sk=a.getSession(),d.api_key=a.settings.api_key,e=a.getSignature(d),d.api_sig=e,d.format="json",d._url=""+a.settings.baseURL,d._method="POST",$.ajax({url:""+chromus.baseURL+"/proxy?_callback=?",data:d,dataType:"jsonp",cache:!0,success:function(a){return a=JSON.parse(a.response),a.error?browser.postMessage({method:"lastfm:error",error:a.error.code}):c()}}))}}},this.chromus.registerPlugin("lastfm",a)}.call(this),function(){var a,b,c,d,e=this;c=chromus.plugins.lastfm,d=chromus.plugins.music_manager,b=void 0,chromus.plugins.music_manager.state.bind("change",function(a){var e,f;if(!store.get("lastfm:scrobbling")||!store.get("lastfm:key"))return;f=d.currentTrack();if(!f)return;a.get("name")==="playing"&&f.id!==b?(e=a.get("played")/f.get("duration")*100,e>30&&f.get("duration")>30&&(b=f.id,c.track.scrobble({artist:f.get("artist"),track:f.get("song"),duration:f.get("duration")}))):a.get("name")==="stopped"&&(b=void 0);if(a.get("name")==="playing"&&a.previous("name")!==a.get("name"))return c.track.updateNowPlaying({artist:f.get("artist"),track:f.get("song"),duration:f.get("duration")})}),a=function(){var a,b,e,f;b=d.playlist.filter(function(a){return a.get("type")==="lastfm:radio_loader"});for(e=0,f=b.length;e<f;e++)a=b[e],a.set({song:"Loading..."});return c.radio.getPlaylist(function(a){return d.playlist.remove(b),d.playlist.add(a)})},chromus.plugins.music_manager.bind("change:current_track",function(){var b,c,e,f,g,h,i;if((h=d.currentTrack())!=null?h.get("lastfm_radio"):void 0){b=d.playlist.indexOf(d.currentTrack()),c=_.first(d.playlist.models,b);for(f=0,g=c.length;f<g;f++)e=c[f],e.get("radio")&&(e.unset("file_url"),e.unset("radio"),e.unset("source_title"),e.unset("source_icon"),e.unset("type"));if(((i=d.nextTrack())!=null?i.get("type"):void 0)==="lastfm:radio_loader")return a()}}),chromus.registerMediaType("lastfm:radio_loader",function(b){return a()}),chromus.registerMediaType("artist",function(a,b){return c.artist.getTopTracks(a.get("artist"),b)}),chromus.registerMediaType("track",function(a,b){return b([{artist:a.get("artist"),song:a.get("song")}])}),chromus.registerMediaType("album",function(a,b){return c.album.getInfo(a.get("artist"),a.get("album"),b)}),chromus.registerMediaType("lastfm:radio",function(a,b){return d.settings.set({repeat:!1,shuffle:!1}),c.radio.tune(a.get("station"),function(){return c.radio.getPlaylist(b)})}),chromus.registerMediaType("lastfm:stream_track",function(a,b){return $.ajax({url:"http://chromusapp.appspot.com/proxy?_callback=?",dataType:"jsonp",data:{_url:a.get("file_url")},cache:!0,success:function(a){return b({file_url:a.headers.location},!1)}})})}.call(this),function(e){function g(a){str="";for(j=0;j<=3;j++)str+=f.charAt(a>>j*8+4&15)+f.charAt(a>>j*8&15);return str}function h(a){nblk=(a.length+8>>6)+1,blks=new Array(nblk*16);for(i=0;i<nblk*16;i++)blks[i]=0;for(i=0;i<a.length;i++)blks[i>>2]|=a.charCodeAt(i)<<i%4*8;return blks[i>>2]|=128<<i%4*8,blks[nblk*16-2]=a.length*8,blks}function k(a,b){var c=(a&65535)+(b&65535),d=(a>>16)+(b>>16)+(c>>16);return d<<16|c&65535}function l(a,b){return a<<b|a>>>32-b}function m(a,b,c,d,e,f){return k(l(k(k(b,a),k(d,f)),e),c)}function n(a,b,c,d,e,f,g){return m(b&c|~b&d,a,b,e,f,g)}function o(a,b,c,d,e,f,g){return m(b&d|c&~d,a,b,e,f,g)}function p(a,b,c,d,e,f,g){return m(b^c^d,a,b,e,f,g)}function q(a,b,c,d,e,f,g){return m(c^(b|~d),a,b,e,f,g)}function r(e){x=h(e),a=1732584193,b=-271733879,c=-1732584194,d=271733878;for(i=0;i<x.length;i+=16)olda=a,oldb=b,oldc=c,oldd=d,a=n(a,b,c,d,x[i+0],7,-680876936),d=n(d,a,b,c,x[i+1],12,-389564586),c=n(c,d,a,b,x[i+2],17,606105819),b=n(b,c,d,a,x[i+3],22,-1044525330),a=n(a,b,c,d,x[i+4],7,-176418897),d=n(d,a,b,c,x[i+5],12,1200080426),c=n(c,d,a,b,x[i+6],17,-1473231341),b=n(b,c,d,a,x[i+7],22,-45705983),a=n(a,b,c,d,x[i+8],7,1770035416),d=n(d,a,b,c,x[i+9],12,-1958414417),c=n(c,d,a,b,x[i+10],17,-42063),b=n(b,c,d,a,x[i+11],22,-1990404162),a=n(a,b,c,d,x[i+12],7,1804603682),d=n(d,a,b,c,x[i+13],12,-40341101),c=n(c,d,a,b,x[i+14],17,-1502002290),b=n(b,c,d,a,x[i+15],22,1236535329),a=o(a,b,c,d,x[i+1],5,-165796510),d=o(d,a,b,c,x[i+6],9,-1069501632),c=o(c,d,a,b,x[i+11],14,643717713),b=o(b,c,d,a,x[i+0],20,-373897302),a=o(a,b,c,d,x[i+5],5,-701558691),d=o(d,a,b,c,x[i+10],9,38016083),c=o(c,d,a,b,x[i+15],14,-660478335),b=o(b,c,d,a,x[i+4],20,-405537848),a=o(a,b,c,d,x[i+9],5,568446438),d=o(d,a,b,c,x[i+14],9,-1019803690),c=o(c,d,a,b,x[i+3],14,-187363961),b=o(b,c,d,a,x[i+8],20,1163531501),a=o(a,b,c,d,x[i+13],5,-1444681467),d=o(d,a,b,c,x[i+2],9,-51403784),c=o(c,d,a,b,x[i+7],14,1735328473),b=o(b,c,d,a,x[i+12],20,-1926607734),a=p(a,b,c,d,x[i+5],4,-378558),d=p(d,a,b,c,x[i+8],11,-2022574463),c=p(c,d,a,b,x[i+11],16,1839030562),b=p(b,c,d,a,x[i+14],23,-35309556),a=p(a,b,c,d,x[i+1],4,-1530992060),d=p(d,a,b,c,x[i+4],11,1272893353),c=p(c,d,a,b,x[i+7],16,-155497632),b=p(b,c,d,a,x[i+10],23,-1094730640),a=p(a,b,c,d,x[i+13],4,681279174),d=p(d,a,b,c,x[i+0],11,-358537222),c=p(c,d,a,b,x[i+3],16,-722521979),b=p(b,c,d,a,x[i+6],23,76029189),a=p(a,b,c,d,x[i+9],4,-640364487),d=p(d,a,b,c,x[i+12],11,-421815835),c=p(c,d,a,b,x[i+15],16,530742520),b=p(b,c,d,a,x[i+2],23,-995338651),a=q(a,b,c,d,x[i+0],6,-198630844),d=q(d,a,b,c,x[i+7],10,1126891415),c=q(c,d,a,b,x[i+14],15,-1416354905),b=q(b,c,d,a,x[i+5],21,-57434055),a=q(a,b,c,d,x[i+12],6,1700485571),d=q(d,a,b,c,x[i+3],10,-1894986606),c=q(c,d,a,b,x[i+10],15,-1051523),b=q(b,c,d,a,x[i+1],21,-2054922799),a=q(a,b,c,d,x[i+8],6,1873313359),d=q(d,a,b,c,x[i+15],10,-30611744),c=q(c,d,a,b,x[i+6],15,-1560198380),b=q(b,c,d,a,x[i+13],21,1309151649),a=q(a,b,c,d,x[i+4],6,-145523070),d=q(d,a,b,c,x[i+11],10,-1120210379),c=q(c,d,a,b,x[i+2],15,718787259),b=q(b,c,d,a,x[i+9],21,-343485551),a=k(a,olda),b=k(b,oldb),c=k(c,oldc),d=k(d,oldd);return g(a)+g(b)+g(c)+g(d)}var f="0123456789abcdef";e.MD5=r}(this),function(){var a,b,c,d;a=function(){function a(){}return a.prototype.initialize=function(){return this.reset()},a.prototype.reset=function(){return this.pages=[],this.page=1,this.played_tracks=[]},a.prototype.getNext=function(a){var b=this;return this.pages.length&&(this.pages=_.shuffle(this.pages),this.page=this.pages[0]),chromus.plugins.lastfm.callMethod("user.getlovedtracks",{user:store.get("lastfm:user"),page:this.page},function(c){var d;return console.warn(b.page,c.lovedtracks.track.length,b.pages),b.pages.length?(d=_.difference(c.lovedtracks.track,b.played_tracks),d=_.shuffle(d),d.length?(d=_.first(d,3),b.played_tracks=_.union(b.played_tracks,d),d=_.map(d,function(a){return{song:a.name,artist:a.artist.name,source_title:"Last.fm Loved Tracks Radio (Free)",source_icon:browser.extension.getURL("/assets/icons/19x19.png"),loved_radio:!0}}),d.push({song:"Load next tracks",artist:"",type:"lastfm:loved_loader",action:!0}),a(d)):(b.pages=_.without(b.pages,b.page),b.getNext(a))):(b.pages=c.lovedtracks["@attr"].totalPages,b.pages=_.range(1,b.pages+1),c.lovedtracks.track.length?b.getNext(a):a([]))})},a}(),d=new a,c=chromus.plugins.music_manager,b=function(){var a,b,e,f;b=c.playlist.filter(function(a){return a.get("type")==="lastfm:loved_loader"});for(e=0,f=b.length;e<f;e++)a=b[e],a.set({song:"Loading..."});return d.getNext(function(a){return c.playlist.remove(b),c.playlist.add(a)})},c.bind("change:current_track",function(){var a,d;a=c.currentTrack();if((a!=null?a.get("loved_radio"):void 0)&&((d=c.nextTrack())!=null?d.get("type"):void 0)==="lastfm:loved_loader")return b()}),chromus.registerMediaType("lastfm:loved_loader",function(a){return b()}),chromus.registerMediaType("lastfm:loved",function(a,b){return d.reset(),c.settings.set({repeat:!1,shuffle:!1}),d.getNext(b)})}.call(this),function(){var a,b;b=this,a={APP_ID:b.debug?"2649785":"2698877",SCOPE:"audio,offline",authURL:function(){var b,c,d,e;return browser.isChrome?b=""+chromus.baseURL+"/chromus/index.html":b=document.location.toString(),d=chromus.plugins_info.vkontakte.path,d=d.replace(/chrome-extension:\/\/\w+\//,""),e=[b,"/../",d,"/oauth.html"].join(""),c=["http://api.vkontakte.ru/oauth/authorize?","client_id="+a.APP_ID,"scope="+a.SCOPE,"redirect_uri="+e,"display=popup","response_type=token"].join("&")},searchWithoutLogin:function(b,c){return $.ajax({url:""+chromus.baseURL+"/api/token/get",dataType:"jsonp",success:function(d){if(!d.error)return b.access_token=d.token,a.searchAPI(b,c)}})},searchAPI:function(a,b){var c,d;return console.warn("searching as logged user"),d=""+a.artist+" "+a.song,c={q:d,format:"json",sort:2,count:10},a.access_token?c.access_token=a.access_token:browser.isPokki?c.access_token=pokki.descrumble(store.get("vk:token")):c.access_token=store.get("vk:token"),$.ajax({url:"https://api.vkontakte.ru/method/audio.search",data:c,dataType:"jsonp",cache:!0,success:function(a){var c;return a.response?(c=_.map(_.rest(a.response),function(a){return{artist:a.artist,song:a.title,duration:parseInt(a.duration),file_url:a.url,source_title:"Vkontakte",source_icon:"http://vkontakte.ru/favicon.ico"}}),b(c)):b([])}})},search:function(b,c){return store.get("vk:user_id")?a.searchAPI(b,c):a.searchWithoutLogin(b,c)}},this.chromus.registerPlugin("vkontakte",a),this.chromus.registerAudioSource("vkontakte",a),browser.addMessageListener(function(a,b,c){switch(a.method){case"vk:auth":return store.set("vk:token",a.auth.access_token),store.set("vk:user_id",a.auth.user_id),$.ajax({url:""+chromus.baseURL+"/api/token/add",data:{token:a.auth.access_token},dataType:"jsonp",success:function(a){return console.log("token added")}}),console.warn("logged!")}})}.call(this)